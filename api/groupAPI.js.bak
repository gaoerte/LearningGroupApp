// api/groupAPI.js - 群组相关API封装

/**
 * 群组API类
 */
class GroupAPI {
  
  /**
   * 通用云函数调用方法
   * @param {Object} params - 调用参数
   * @returns {Promise<Object>} - 返回Promise
   */
  static async callCloudFunction(params) {
    return new Promise((resolve, reject) => {
      console.log(`[GroupAPI] 调用云函数: ${params.action}`);
      
      uni.cloud.callFunction({
        name: 'groupManager',
        data: params,
        success: (res) => {
          try {
            // 安全地处理响应
            let result = res.result;
            
            // 如果返回的是字符串，尝试解析JSON
            if (typeof result === 'string') {
              try {
                result = JSON.parse(result);
              } catch (parseError) {
                console.warn(`[GroupAPI] ${params.action} 响应解析失败:`, parseError);
              }
            }
            
            if (result && result.success) {
              console.log(`[GroupAPI] ${params.action} 成功:`, result);
              resolve(result);
            } else {
              console.error(`[GroupAPI] ${params.action} 失败:`, result?.error || '未知错误');
              reject(new Error(result?.error || `${params.action}操作失败`));
            }
          } catch (error) {
            console.error(`[GroupAPI] ${params.action} 响应处理异常:`, error);
            reject(error);
          }
        },
        fail: (error) => {
          console.error(`[GroupAPI] ${params.action} 请求失败:`, error);
          reject(new Error(error.errMsg || error.message || '请求失败'));
        }
      });
    });
  }
  
  /**
   * 创建群组
   */
  static async createGroup(openid, groupInfo) {
    return this.callCloudFunction({
      action: 'create',
      openid: openid,
      groupInfo: groupInfo
    });
  }

  /**
   * 搜索群组
   */
  static async searchGroups(searchQuery = '') {
    return new Promise((resolve, reject) => {
      uni.cloud.callFunction({
        name: 'groupManager',
        data: {
          action: 'search',
          searchQuery: searchQuery
        },
        success: (res) => {
          console.log('群组搜索成功:', res.result);
          resolve(res.result);
        },
        fail: (error) => {
          console.error('群组搜索失败:', error);
          reject(error);
        }
      });
    });
  }

  /**
   * 加入群组
   */
  static async joinGroup(openid, groupId) {
    return new Promise((resolve, reject) => {
      uni.cloud.callFunction({
        name: 'groupManager',
        data: {
          action: 'join',
          openid: openid,
          groupId: groupId
        },
        success: (res) => {
          console.log('加入群组成功:', res.result);
          resolve(res.result);
        },
        fail: (error) => {
          console.error('加入群组失败:', error);
          reject(error);
        }
      });
    });
  }

  /**
   * 退出群组
   */
  static async leaveGroup(openid, groupId) {
    return new Promise((resolve, reject) => {
      uni.cloud.callFunction({
        name: 'groupManager',
        data: {
          action: 'leave',
          openid: openid,
          groupId: groupId
        },
        success: (res) => {
          console.log('退出群组成功:', res.result);
          resolve(res.result);
        },
        fail: (error) => {
          console.error('退出群组失败:', error);
          reject(error);
        }
      });
    });
  }

  /**
   * 获取用户加入的群组列表
   */
  static async getUserGroups(openid) {
    return new Promise((resolve, reject) => {
      uni.cloud.callFunction({
        name: 'groupManager',
        data: {
          action: 'list',
          openid: openid
        },
        success: (res) => {
          console.log('获取群组列表成功:', res.result);
          resolve(res.result);
        },
        fail: (error) => {
          console.error('获取群组列表失败:', error);
          reject(error);
        }
      });
    });
  }

  /**
   * 获取群组详情
   */
  static async getGroupInfo(groupId) {
    return new Promise((resolve, reject) => {
      uni.cloud.callFunction({
        name: 'groupManager',
        data: {
          action: 'get',
          groupId: groupId
        },
        success: (res) => {
          console.log('获取群组详情成功:', res.result);
          resolve(res.result);
        },
        fail: (error) => {
          console.error('获取群组详情失败:', error);
          reject(error);
        }
      });
    });
  }
}

export default GroupAPI;
