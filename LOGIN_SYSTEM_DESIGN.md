# ç”¨æˆ·ç™»å½•ç³»ç»Ÿ - å®Œæ•´è®¾è®¡æ–¹æ¡ˆ

## ğŸ¯ ç™»å½•ç³»ç»Ÿæ¶æ„è®¾è®¡

### ğŸ“‹ è¿è¡Œé€»è¾‘æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»ç™»å½•
    â†“
è·å–å¾®ä¿¡æˆæƒç 
    â†“
è°ƒç”¨äº‘å‡½æ•°éªŒè¯
    â†“
è·å–ç”¨æˆ·openid
    â†“
æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    â†“
ã€ä¸å­˜åœ¨ã€‘â†’ åˆ›å»ºæ–°ç”¨æˆ· â†’ ã€å­˜åœ¨ã€‘â†’ æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    â†“
ä¿å­˜ç™»å½•çŠ¶æ€
    â†“
è·³è½¬åˆ°é¦–é¡µ
```

### ğŸ”§ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

#### 1. å‰ç«¯ç™»å½•æµç¨‹
```javascript
// pages/login/login.vue
1. ç”¨æˆ·ç‚¹å‡»"å¾®ä¿¡ç™»å½•"æŒ‰é’®
2. è°ƒç”¨ uni.login() è·å–ä¸´æ—¶æˆæƒç 
3. è°ƒç”¨ UserAPI.wechatLogin(code) 
4. å¤„ç†ç™»å½•ç»“æœï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯
5. è·³è½¬åˆ°é¦–é¡µ
```

#### 2. APIå±‚å¤„ç†
```javascript
// api/userAPI.js
1. UserAPI.wechatLogin(code) 
2. è°ƒç”¨ supabaseCore äº‘å‡½æ•°
3. action: 'wechatLogin'
4. è¿”å›ç”¨æˆ·ä¿¡æ¯å’Œopenid
```

#### 3. äº‘å‡½æ•°å¤„ç†
```javascript
// cloudfunctions/supabaseCore/index.js
1. æ¥æ”¶action: 'wechatLogin'
2. è°ƒç”¨å¾®ä¿¡APIéªŒè¯code
3. è·å–openidå’Œç”¨æˆ·ä¿¡æ¯
4. æŸ¥è¯¢æˆ–åˆ›å»ºç”¨æˆ·è®°å½•
5. è¿”å›å®Œæ•´ç”¨æˆ·ä¿¡æ¯
```

#### 4. æ•°æ®åº“æ“ä½œ
```sql
-- ç”¨æˆ·è¡¨æŸ¥è¯¢/åˆ›å»º
1. æ ¹æ®openidæŸ¥è¯¢ç”¨æˆ·
2. å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·è®°å½•
3. æ›´æ–°ç”¨æˆ·æœ€åç™»å½•æ—¶é—´
4. è¿”å›ç”¨æˆ·å®Œæ•´ä¿¡æ¯
```

### ğŸ“ æ¶‰åŠçš„æ–‡ä»¶

1. **pages/login/login.vue** - ç™»å½•é¡µé¢UIå’Œé€»è¾‘
2. **api/userAPI.js** - ç”¨æˆ·APIå°è£…
3. **cloudfunctions/supabaseCore/index.js** - äº‘å‡½æ•°å¤„ç†
4. **utils/storage.js** - æœ¬åœ°å­˜å‚¨ç®¡ç†
5. **store/modules/user.js** - ç”¨æˆ·çŠ¶æ€ç®¡ç†

### ğŸ¯ å®ç°æ­¥éª¤

#### Step 1: å®Œå–„UserAPI
- æ·»åŠ wechatLoginæ–¹æ³•
- æ·»åŠ getUserProfileæ–¹æ³•
- æ·»åŠ updateUserInfoæ–¹æ³•

#### Step 2: äº‘å‡½æ•°æ‰©å±•
- æ·»åŠ wechatLogin action
- é›†æˆå¾®ä¿¡APIè°ƒç”¨
- å®ç°ç”¨æˆ·æ•°æ®åº“æ“ä½œ

#### Step 3: å‰ç«¯é€»è¾‘ä¼˜åŒ–
- é‡æ„ç™»å½•é¡µé¢é€»è¾‘
- æ·»åŠ ç”¨æˆ·çŠ¶æ€ç®¡ç†
- å®ç°ç™»å½•çŠ¶æ€æŒä¹…åŒ–

#### Step 4: é”™è¯¯å¤„ç†
- ç½‘ç»œé”™è¯¯å¤„ç†
- æˆæƒå¤±è´¥å¤„ç†
- ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´å¤„ç†

### ğŸ” å®‰å…¨è€ƒè™‘

1. **Tokenç®¡ç†**ï¼šä½¿ç”¨JWTæˆ–è‡ªå®šä¹‰token
2. **ä¼šè¯æœ‰æ•ˆæœŸ**ï¼šè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
3. **ç”¨æˆ·ä¿¡æ¯åŠ å¯†**ï¼šæ•æ„Ÿä¿¡æ¯æœ¬åœ°åŠ å¯†å­˜å‚¨
4. **æƒé™æ§åˆ¶**ï¼šä¸åŒç”¨æˆ·ç±»å‹çš„æƒé™ç®¡ç†

### ğŸ“Š ç”¨æˆ·æ•°æ®ç»“æ„

```javascript
// å®Œæ•´ç”¨æˆ·ä¿¡æ¯å¯¹è±¡
{
  id: "uuid",
  openid: "wx_openid_123",
  nickname: "ç”¨æˆ·æ˜µç§°",
  avatar_url: "å¤´åƒé“¾æ¥",
  email: "å¯é€‰é‚®ç®±",
  phone: "å¯é€‰æ‰‹æœºå·",
  total_checkin_days: 0,
  continuous_checkin_days: 0,
  last_checkin_date: null,
  last_login_time: "2025-07-03T14:30:00Z",
  status: "active",
  created_at: "2025-07-03T14:30:00Z",
  updated_at: "2025-07-03T14:30:00Z"
}
```

### ğŸš€ æœ¬åœ°å­˜å‚¨ç­–ç•¥

```javascript
// ç™»å½•æˆåŠŸåä¿å­˜çš„ä¿¡æ¯
uni.setStorageSync('user_token', token);
uni.setStorageSync('user_openid', openid);
uni.setStorageSync('user_info', userInfo);
uni.setStorageSync('login_time', timestamp);
```

### ğŸ”„ ç™»å½•çŠ¶æ€æ£€æŸ¥

```javascript
// åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
1. è¯»å–æœ¬åœ°token
2. éªŒè¯tokenæœ‰æ•ˆæ€§
3. å¦‚æœæ— æ•ˆï¼Œæ¸…é™¤æœ¬åœ°æ•°æ®ï¼Œè·³è½¬ç™»å½•é¡µ
4. å¦‚æœæœ‰æ•ˆï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼Œè¿›å…¥ä¸»é¡µ
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å®ç°è®¡åˆ’

1. **ä»Šå¤©**ï¼šå®Œå–„UserAPIå’Œäº‘å‡½æ•°wechatLogin
2. **æ˜å¤©**ï¼šé‡æ„ç™»å½•é¡µé¢é€»è¾‘
3. **åå¤©**ï¼šæ·»åŠ ç”¨æˆ·çŠ¶æ€ç®¡ç†å’ŒæŒä¹…åŒ–
4. **å®Œæˆ**ï¼šæµ‹è¯•æ‰€æœ‰ç™»å½•åœºæ™¯å’Œé”™è¯¯å¤„ç†
