# LearningGroupApp 后端架构方案

## 架构选择：云函数代理 + Supabase

### 1. 整体架构
```
小程序端 → 云函数(代理层) → Supabase(数据存储)
```

### 2. 架构优势

**为什么选择这个方案：**
- ✅ **绕过域名限制**：小程序只需访问云函数，无需配置 Supabase 域名白名单
- ✅ **安全性**：敏感的 API Key 在服务端，前端无法获取
- ✅ **简化部署**：无需额外的服务器，利用微信云开发基础设施
- ✅ **成本控制**：云函数按调用收费，Supabase 有免费额度
- ✅ **开发效率**：Supabase 提供强大的数据库、实时订阅、文件存储功能

### 3. 核心组件

#### 3.1 云函数层
- `wechatLogin`: 处理微信登录，获取用户 openId
- `userData`: 用户数据 CRUD 操作
- `groupData`: 群组相关操作
- `checkinData`: 打卡数据处理
- `aiChat`: AI 聊天接口代理

#### 3.2 Supabase 数据层
- **PostgreSQL 数据库**：用户、群组、打卡、消息存储
- **Row Level Security (RLS)**：数据权限控制
- **Real-time**：群组消息实时推送
- **Storage**：文件上传（头像、打卡图片）

## 4. 当前实现状态

### 4.1 ✅ 已完成
- 云函数 `wechatLogin` 基础实现（直接使用 openId）
- 云函数 `userData` 框架搭建
- Supabase 数据库表结构设计
- 前端 API 封装和错误处理
- 项目配置优化（vite.config.js、package.json）

### 4.2 🔄 进行中
- 云函数与 Supabase 集成调试
- 用户登录流程完整测试

### 4.3 📋 待实现
- 群组管理云函数
- 打卡系统云函数
- AI 聊天接口云函数
- 实时消息推送集成

## 5. 实现细节

### 5.1 身份认证流程
```javascript
// 前端调用
uni.getUserProfile() → wx.login() → 云函数(wechatLogin) → 返回用户信息

// 云函数处理
1. 获取 event.userInfo.openId (推荐)
2. 或从 context.WX_OPENID 获取
3. 生成 access_token
4. 返回用户信息
```

### 5.2 数据操作流程
```javascript
// 前端 → 云函数 → Supabase
小程序调用 → userData云函数 → Supabase API → 返回结果
```

### 5.3 安全考虑
- Supabase API Key 只在云函数中使用
- RLS 策略确保用户只能访问自己的数据
- 云函数验证用户身份后再操作数据

## 6. 部署建议

### 6.1 开发环境
1. 本地开发使用微信开发者工具
2. 云函数本地调试
3. Supabase 使用免费层

### 6.2 生产环境
1. 微信云开发正式环境
2. Supabase Pro 计划（如需要）
3. 配置域名和 SSL 证书

## 7. 扩展性考虑

### 7.1 性能优化
- 云函数代码优化，减少冷启动
- Supabase 索引优化
- 数据缓存策略

### 7.2 功能扩展
- 支付功能：云函数 + 微信支付
- 推送通知：云函数 + 模板消息
- 数据分析：Supabase + 第三方分析工具

## 8. 风险评估

### 8.1 技术风险
- **云函数限制**：执行时间、内存限制
- **Supabase 依赖**：第三方服务稳定性
- **网络延迟**：云函数 → Supabase 的网络延迟

### 8.2 解决方案
- 云函数代码优化，拆分复杂操作
- 备用方案：考虑自建数据库
- 本地缓存和离线支持

## 9. 总结

这个架构方案在当前项目规模下是最优选择：
- 开发成本低，维护简单
- 安全性有保障
- 扩展性良好
- 符合小程序生态特点

接下来的重点是完善云函数与 Supabase 的集成，确保各个功能模块的稳定运行。
